version: '3.8'

services:
  # 后端应用
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zxsj-backend
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # 应用配置
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      
      # 数据库配置 - 通过环境变量提供
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      
      # 定时任务配置
      SCHEDULER_TIMEZONE: ${SCHEDULER_TIMEZONE:-Asia/Shanghai}
      
      # 日志配置
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # CORS 配置
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      
      # API 文档配置
      SWAGGER_TITLE: ${SWAGGER_TITLE:-诛仙世界多账号管理系统 API}
      SWAGGER_DESCRIPTION: ${SWAGGER_DESCRIPTION:-用于管理诛仙世界游戏多个账号的进度跟踪系统}
      SWAGGER_VERSION: ${SWAGGER_VERSION:-1.0.0}
      SWAGGER_PATH: ${SWAGGER_PATH:-api-docs}
      
      # 管理员账户配置（从 .env 注入，不提供默认值）
      DEFAULT_ADMIN_USERNAME: ${DEFAULT_ADMIN_USERNAME}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD}
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL}
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zxsj-network

  # Nginx 反向代理 (可选)
  nginx:
    image: nginx:alpine
    container_name: zxsj-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - zxsj-network
    profiles:
      - with-nginx

networks:
  zxsj-network:
    driver: bridge

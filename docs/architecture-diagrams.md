# 多账号管理系统架构图

本文档包含多账号管理系统的各种架构图，使用Mermaid语法绘制，帮助理解系统的业务逻辑、用户状态流转、权限关系和模块交互。

## 1. 管理员业务逻辑流程图

### 1.1 管理员账号管理流程

```mermaid
flowchart TD
    A[管理员登录] --> B{身份验证}
    B -->|成功| C[获取管理员权限]
    B -->|失败| D[返回认证错误]
    
    C --> E[账号管理菜单]
    E --> F[创建共享账号]
    E --> G[查看所有账号]
    E --> H[修改账号信息]
    E --> I[删除账号]
    
    F --> F1[输入账号信息]
    F1 --> F2[验证账号名唯一性]
    F2 -->|通过| F3[创建账号记录]
    F2 -->|失败| F4[返回重复错误]
    F3 --> F5[设置默认权限]
    F5 --> F6[记录操作日志]
    F6 --> F7[返回创建成功]
    
    G --> G1[查询所有账号列表]
    G1 --> G2[应用分页和过滤]
    G2 --> G3[返回账号数据]
    
    H --> H1[选择目标账号]
    H1 --> H2[验证修改权限]
    H2 -->|有权限| H3[更新账号信息]
    H2 -->|无权限| H4[返回权限错误]
    H3 --> H5[记录变更日志]
    H5 --> H6[返回更新成功]
    
    I --> I1[选择要删除的账号]
    I1 --> I2[检查账号依赖关系]
    I2 -->|有依赖| I3[返回依赖错误]
    I2 -->|无依赖| I4[执行软删除]
    I4 --> I5[清理相关权限]
    I5 --> I6[记录删除日志]
    I6 --> I7[返回删除成功]
```

### 1.2 管理员用户管理流程

```mermaid
flowchart TD
    A[管理员用户管理] --> B[用户操作选择]
    
    B --> C[创建用户]
    B --> D[查看用户列表]
    B --> E[修改用户信息]
    B --> F[删除用户]
    B --> G[管理用户权限]
    
    C --> C1[输入用户信息]
    C1 --> C2[验证邮箱唯一性]
    C2 -->|通过| C3[加密用户密码]
    C2 -->|失败| C4[返回重复错误]
    C3 --> C5[创建用户记录]
    C5 --> C6[设置默认角色]
    C6 --> C7[发送欢迎邮件]
    C7 --> C8[记录创建日志]
    
    D --> D1[应用搜索条件]
    D1 --> D2[执行分页查询]
    D2 --> D3[返回用户列表]
    
    E --> E1[选择目标用户]
    E1 --> E2[验证修改权限]
    E2 -->|有权限| E3[更新用户信息]
    E2 -->|无权限| E4[返回权限错误]
    E3 --> E5[处理密码更新]
    E5 --> E6[记录修改日志]
    
    F --> F1[选择要删除的用户]
    F1 --> F2[检查用户关联数据]
    F2 -->|有关联| F3[转移或清理数据]
    F2 -->|无关联| F4[执行用户删除]
    F3 --> F4
    F4 --> F5[清理用户权限]
    F5 --> F6[记录删除日志]
    
    G --> G1[选择用户和账号]
    G1 --> G2[设置权限级别]
    G2 --> G3[验证权限配置]
    G3 --> G4[更新权限关系]
    G4 --> G5[通知相关用户]
    G5 --> G6[记录权限变更日志]
```

### 1.3 管理员系统配置流程

```mermaid
flowchart TD
    A[系统配置管理] --> B[配置类型选择]
    
    B --> C[系统参数配置]
    B --> D[权限策略配置]
    B --> E[安全策略配置]
    B --> F[日志配置]
    
    C --> C1[查看当前配置]
    C1 --> C2[修改配置参数]
    C2 --> C3[验证配置有效性]
    C3 -->|有效| C4[保存配置更改]
    C3 -->|无效| C5[返回验证错误]
    C4 --> C6[重新加载配置]
    C6 --> C7[记录配置变更]
    
    D --> D1[查看权限策略]
    D1 --> D2[修改默认权限]
    D2 --> D3[设置权限继承规则]
    D3 --> D4[验证权限逻辑]
    D4 --> D5[应用权限策略]
    D5 --> D6[通知系统更新]
    
    E --> E1[密码策略设置]
    E1 --> E2[会话超时配置]
    E2 --> E3[访问控制设置]
    E3 --> E4[安全审计配置]
    E4 --> E5[保存安全策略]
    
    F --> F1[日志级别设置]
    F1 --> F2[日志存储配置]
    F2 --> F3[日志轮转设置]
    F3 --> F4[审计日志配置]
    F4 --> F5[应用日志配置]
```

## 2. 普通用户业务状态图

### 2.1 用户账号状态流转

```mermaid
stateDiagram-v2
    [*] --> 未登录
    
    未登录 --> 已登录 : 成功登录
    未登录 --> 登录失败 : 认证失败
    登录失败 --> 未登录 : 重新尝试
    
    已登录 --> 查看账号列表 : 访问账号管理
    已登录 --> 创建个人账号 : 创建新账号
    已登录 --> 已注销 : 用户注销
    
    查看账号列表 --> 查看账号详情 : 选择账号
    查看账号列表 --> 搜索过滤 : 应用过滤条件
    搜索过滤 --> 查看账号列表 : 显示结果
    
    查看账号详情 --> 编辑账号 : 有写权限
    查看账号详情 --> 只读模式 : 只有读权限
    查看账号详情 --> 权限不足 : 无访问权限
    
    编辑账号 --> 保存成功 : 验证通过
    编辑账号 --> 保存失败 : 验证失败
    保存成功 --> 查看账号详情 : 返回详情页
    保存失败 --> 编辑账号 : 重新编辑
    
    创建个人账号 --> 输入账号信息 : 开始创建
    输入账号信息 --> 验证信息 : 提交信息
    验证信息 --> 创建成功 : 验证通过
    验证信息 --> 创建失败 : 验证失败
    创建成功 --> 查看账号详情 : 查看新账号
    创建失败 --> 输入账号信息 : 重新输入
    
    只读模式 --> 查看账号列表 : 返回列表
    权限不足 --> 查看账号列表 : 返回列表
    
    已注销 --> [*]
```

### 2.2 用户权限状态流转

```mermaid
stateDiagram-v2
    [*] --> 无权限用户
    
    无权限用户 --> 被邀请用户 : 收到共享账号邀请
    无权限用户 --> 账号拥有者 : 创建个人账号
    
    被邀请用户 --> 只读用户 : 接受只读权限
    被邀请用户 --> 贡献者用户 : 接受贡献者权限
    被邀请用户 --> 拒绝邀请 : 拒绝邀请
    拒绝邀请 --> 无权限用户 : 回到初始状态
    
    只读用户 --> 贡献者用户 : 权限升级
    只读用户 --> 权限被撤销 : 权限被移除
    
    贡献者用户 --> 只读用户 : 权限降级
    贡献者用户 --> 账号拥有者 : 转让拥有权
    贡献者用户 --> 权限被撤销 : 权限被移除
    
    账号拥有者 --> 贡献者用户 : 转让拥有权
    账号拥有者 --> 账号已删除 : 删除账号
    
    权限被撤销 --> 无权限用户 : 清理权限
    账号已删除 --> 无权限用户 : 账号不存在
    
    state 只读用户 {
        [*] --> 可查看
        可查看 --> 可查看 : 读取操作
    }
    
    state 贡献者用户 {
        [*] --> 可读写
        可读写 --> 可读写 : 读写操作
        可读写 --> 操作受限 : 尝试删除操作
        操作受限 --> 可读写 : 继续其他操作
    }
    
    state 账号拥有者 {
        [*] --> 完全控制
        完全控制 --> 管理权限 : 管理其他用户
        完全控制 --> 修改账号 : 修改账号信息
        完全控制 --> 删除账号 : 删除整个账号
        管理权限 --> 完全控制
        修改账号 --> 完全控制
    }
```

### 2.3 用户操作流程状态

```mermaid
stateDiagram-v2
    [*] --> 操作开始
    
    操作开始 --> 权限检查 : 发起操作请求
    
    权限检查 --> 权限验证通过 : 有足够权限
    权限检查 --> 权限验证失败 : 权限不足
    
    权限验证失败 --> 操作被拒绝 : 返回403错误
    操作被拒绝 --> [*]
    
    权限验证通过 --> 数据验证 : 检查操作数据
    
    数据验证 --> 数据验证通过 : 数据格式正确
    数据验证 --> 数据验证失败 : 数据格式错误
    
    数据验证失败 --> 操作失败 : 返回400错误
    操作失败 --> [*]
    
    数据验证通过 --> 业务逻辑处理 : 执行业务操作
    
    业务逻辑处理 --> 处理成功 : 业务逻辑正确
    业务逻辑处理 --> 处理失败 : 业务逻辑错误
    
    处理失败 --> 操作失败 : 返回业务错误
    
    处理成功 --> 数据持久化 : 保存数据变更
    
    数据持久化 --> 持久化成功 : 数据库操作成功
    数据持久化 --> 持久化失败 : 数据库操作失败
    
    持久化失败 --> 操作失败 : 返回500错误
    
    持久化成功 --> 日志记录 : 记录操作日志
    日志记录 --> 通知处理 : 发送相关通知
    通知处理 --> 操作完成 : 返回成功结果
    
    操作完成 --> [*]
```

## 3. 共享角色账号权限关系图

### 3.1 权限层级关系图

```mermaid
graph TD
    A[系统管理员] --> B[共享账号管理]
    A --> C[用户管理]
    A --> D[系统配置]
    
    B --> E[创建共享账号]
    B --> F[删除任意共享账号]
    B --> G[修改任意共享账号]
    B --> H[管理任意账号权限]
    
    I[账号拥有者] --> J[账号完全控制]
    J --> K[修改账号信息]
    J --> L[删除账号]
    J --> M[管理用户权限]
    J --> N[查看账号详情]
    
    O[贡献者] --> P[账号读写权限]
    P --> Q[修改账号信息]
    P --> R[查看账号详情]
    P --> S[参与协作]
    
    T[只读用户] --> U[账号只读权限]
    U --> V[查看账号详情]
    U --> W[查看账号数据]
    
    X[无权限用户] --> Y[无访问权限]
    Y --> Z[访问被拒绝]
    
    subgraph "权限级别"
        A1[系统级] --> A2[账号级] --> A3[操作级]
    end
    
    subgraph "权限类型"
        B1[读权限 - READ]
        B2[写权限 - WRITE]
        B3[删除权限 - DELETE]
        B4[管理权限 - MANAGE]
    end
    
    subgraph "角色类型"
        C1[OWNER - 拥有者]
        C2[CONTRIBUTOR - 贡献者]
        C3[READONLY - 只读]
        C4[NONE - 无权限]
    end
```

### 3.2 权限继承和覆盖关系

```mermaid
graph LR
    A[默认权限配置] --> B{用户角色类型}
    
    B -->|OWNER| C[拥有者默认权限]
    B -->|CONTRIBUTOR| D[贡献者默认权限]
    B -->|READONLY| E[只读默认权限]
    
    C --> C1[READ: true]
    C --> C2[WRITE: true]
    C --> C3[DELETE: true]
    C --> C4[MANAGE: true]
    
    D --> D1[READ: true]
    D --> D2[WRITE: true]
    D --> D3[DELETE: false]
    D --> D4[MANAGE: false]
    
    E --> E1[READ: true]
    E --> E2[WRITE: false]
    E --> E3[DELETE: false]
    E --> E4[MANAGE: false]
    
    F[自定义权限配置] --> G{是否有自定义权限}
    G -->|是| H[覆盖默认权限]
    G -->|否| I[使用默认权限]
    
    H --> J[最终权限 = 自定义权限]
    I --> K[最终权限 = 默认权限]
    
    subgraph "权限计算逻辑"
        L[1. 获取用户角色]
        M[2. 加载默认权限]
        N[3. 检查自定义权限]
        O[4. 应用权限覆盖]
        P[5. 返回最终权限]
        
        L --> M --> N --> O --> P
    end
```

### 3.3 多用户权限矩阵

```mermaid
graph TD
    subgraph "共享账号A"
        A1[用户1 - OWNER]
        A2[用户2 - CONTRIBUTOR]
        A3[用户3 - READONLY]
    end
    
    subgraph "共享账号B"
        B1[用户1 - CONTRIBUTOR]
        B2[用户2 - OWNER]
        B3[用户4 - READONLY]
    end
    
    subgraph "共享账号C"
        C1[用户3 - OWNER]
        C2[用户4 - CONTRIBUTOR]
        C3[用户5 - READONLY]
    end
    
    subgraph "权限操作矩阵"
        D[权限检查服务]
        D --> D1[checkPermission]
        D --> D2[canRead]
        D --> D3[canWrite]
        D --> D4[canDelete]
        D --> D5[getUserPermissions]
    end
    
    A1 --> D
    A2 --> D
    A3 --> D
    B1 --> D
    B2 --> D
    B3 --> D
    C1 --> D
    C2 --> D
    C3 --> D
    
    subgraph "权限验证结果"
        E1[READ: 允许/拒绝]
        E2[WRITE: 允许/拒绝]
        E3[DELETE: 允许/拒绝]
        E4[MANAGE: 允许/拒绝]
    end
    
    D1 --> E1
    D2 --> E1
    D3 --> E2
    D4 --> E3
    D5 --> E4
```

## 4. 系统各模块交互时序图

### 4.1 用户登录和权限验证时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as 控制器
    participant A as 认证服务
    participant P as 权限服务
    participant D as 数据库
    participant L as 日志服务
    
    U->>C: 发送登录请求
    C->>A: 验证用户凭据
    A->>D: 查询用户信息
    D-->>A: 返回用户数据
    A->>A: 验证密码
    
    alt 认证成功
        A->>A: 生成JWT令牌
        A-->>C: 返回令牌和用户信息
        C->>L: 记录登录成功日志
        C-->>U: 返回登录成功响应
    else 认证失败
        A-->>C: 返回认证失败
        C->>L: 记录登录失败日志
        C-->>U: 返回401错误
    end
    
    Note over U,L: 后续请求权限验证
    
    U->>C: 发送业务请求(带JWT)
    C->>A: 验证JWT令牌
    A->>A: 解析令牌获取用户ID
    A-->>C: 返回用户身份
    C->>P: 检查操作权限
    P->>D: 查询用户权限关系
    D-->>P: 返回权限数据
    P->>P: 计算权限结果
    P-->>C: 返回权限检查结果
    
    alt 权限验证通过
        C->>C: 执行业务逻辑
        C->>D: 执行数据操作
        D-->>C: 返回操作结果
        C->>L: 记录操作日志
        C-->>U: 返回业务响应
    else 权限验证失败
        C->>L: 记录权限拒绝日志
        C-->>U: 返回403错误
    end
```

### 4.2 共享账号创建和权限分配时序图

```mermaid
sequenceDiagram
    participant A as 管理员
    participant C as 账号控制器
    participant S as 账号服务
    participant P as 权限服务
    participant D as 数据库
    participant N as 通知服务
    participant L as 日志服务
    
    A->>C: 创建共享账号请求
    C->>C: 验证管理员权限
    C->>S: 调用创建账号服务
    S->>D: 检查账号名唯一性
    D-->>S: 返回检查结果
    
    alt 账号名可用
        S->>D: 创建账号记录
        D-->>S: 返回账号ID
        S->>P: 设置拥有者权限
        P->>D: 创建权限关系记录
        D-->>P: 确认权限创建
        P-->>S: 权限设置完成
        S->>L: 记录账号创建日志
        S-->>C: 返回创建成功
        C-->>A: 返回账号信息
    else 账号名重复
        S-->>C: 返回重复错误
        C-->>A: 返回400错误
    end
    
    Note over A,L: 添加其他用户到共享账号
    
    A->>C: 添加用户权限请求
    C->>P: 验证管理权限
    P->>D: 检查当前用户权限
    D-->>P: 返回权限信息
    
    alt 有管理权限
        P->>D: 创建用户权限关系
        D-->>P: 确认关系创建
        P->>N: 发送权限通知
        N->>N: 准备通知内容
        N-->>P: 通知发送完成
        P->>L: 记录权限变更日志
        P-->>C: 返回权限添加成功
        C-->>A: 返回成功响应
    else 无管理权限
        P-->>C: 返回权限不足
        C-->>A: 返回403错误
    end
```

### 4.3 并发操作处理时序图

```mermaid
sequenceDiagram
    participant U1 as 用户1
    participant U2 as 用户2
    participant C as 控制器
    participant S as 服务层
    participant T as 事务管理器
    participant D as 数据库
    participant L as 锁管理器
    
    Note over U1,L: 并发更新同一共享账号
    
    par 用户1操作
        U1->>C: 更新账号请求1
        C->>S: 处理更新请求1
        S->>T: 开始事务1
        T->>L: 请求行锁
        L-->>T: 获得锁1
        T->>D: 读取当前数据
        D-->>T: 返回数据版本V1
    and 用户2操作
        U2->>C: 更新账号请求2
        C->>S: 处理更新请求2
        S->>T: 开始事务2
        T->>L: 请求行锁
        Note right of L: 等待锁释放
    end
    
    T->>D: 执行更新操作1
    D-->>T: 更新成功
    T->>T: 提交事务1
    T->>L: 释放锁1
    T-->>S: 事务1完成
    S-->>C: 更新1成功
    C-->>U1: 返回成功响应
    
    L-->>T: 获得锁2(事务2)
    T->>D: 读取当前数据
    D-->>T: 返回数据版本V2
    T->>D: 执行更新操作2
    D-->>T: 更新成功
    T->>T: 提交事务2
    T->>L: 释放锁2
    T-->>S: 事务2完成
    S-->>C: 更新2成功
    C-->>U2: 返回成功响应
    
    Note over U1,L: 数据一致性得到保证
```

### 4.4 权限检查和缓存时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as 控制器
    participant P as 权限服务
    participant Cache as 权限缓存
    participant D as 数据库
    participant L as 日志服务
    
    U->>C: 发送操作请求
    C->>P: 检查用户权限
    P->>Cache: 查询权限缓存
    
    alt 缓存命中
        Cache-->>P: 返回缓存权限
        P->>P: 验证权限有效性
        alt 权限有效
            P-->>C: 返回权限结果
            C->>C: 执行业务逻辑
            C-->>U: 返回操作结果
        else 权限过期
            P->>D: 查询最新权限
            D-->>P: 返回权限数据
            P->>Cache: 更新权限缓存
            P-->>C: 返回权限结果
        end
    else 缓存未命中
        P->>D: 查询用户权限
        D-->>P: 返回权限数据
        P->>P: 计算权限结果
        P->>Cache: 存储权限缓存
        P-->>C: 返回权限结果
        
        alt 权限验证通过
            C->>C: 执行业务逻辑
            C->>L: 记录操作日志
            C-->>U: 返回成功结果
        else 权限验证失败
            C->>L: 记录权限拒绝日志
            C-->>U: 返回403错误
        end
    end
    
    Note over U,L: 权限变更时的缓存更新
    
    U->>C: 权限变更请求
    C->>P: 更新用户权限
    P->>D: 执行权限更新
    D-->>P: 确认更新成功
    P->>Cache: 清除相关缓存
    Cache-->>P: 缓存清除完成
    P->>L: 记录权限变更日志
    P-->>C: 返回更新成功
    C-->>U: 返回成功响应
```

### 4.5 系统监控和日志记录时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as 控制器
    participant S as 业务服务
    participant L as 日志服务
    participant M as 监控服务
    participant A as 告警服务
    participant DB as 数据库
    
    U->>C: 发送业务请求
    C->>M: 记录请求开始时间
    C->>S: 调用业务服务
    
    S->>L: 记录业务开始日志
    S->>DB: 执行数据库操作
    
    alt 操作成功
        DB-->>S: 返回操作结果
        S->>L: 记录操作成功日志
        S->>M: 记录性能指标
        S-->>C: 返回业务结果
        C->>M: 记录请求完成时间
        C->>L: 记录请求完成日志
        C-->>U: 返回成功响应
    else 操作失败
        DB-->>S: 返回错误信息
        S->>L: 记录错误日志
        S->>M: 记录错误指标
        S-->>C: 返回错误结果
        C->>M: 记录请求失败
        C->>L: 记录请求失败日志
        C-->>U: 返回错误响应
    end
    
    M->>M: 分析性能指标
    
    alt 性能异常
        M->>A: 触发性能告警
        A->>A: 准备告警信息
        A->>A: 发送告警通知
    else 错误率异常
        M->>A: 触发错误告警
        A->>A: 准备告警信息
        A->>A: 发送告警通知
    else 正常情况
        M->>M: 更新监控仪表板
    end
    
    Note over U,DB: 定期日志清理和归档
    
    L->>L: 检查日志大小
    alt 需要清理
        L->>L: 归档旧日志
        L->>L: 清理过期日志
        L->>M: 更新存储指标
    end
```

## 5. 数据流架构图

### 5.1 数据流向图

```mermaid
graph TD
    A[用户请求] --> B[API网关]
    B --> C[身份认证]
    C --> D[权限验证]
    D --> E[业务控制器]
    
    E --> F[业务服务层]
    F --> G[数据访问层]
    G --> H[数据库]
    
    F --> I[缓存层]
    F --> J[日志服务]
    F --> K[通知服务]
    
    subgraph "数据存储"
        H --> H1[用户表]
        H --> H2[账号表]
        H --> H3[权限关系表]
        H --> H4[操作日志表]
    end
    
    subgraph "缓存系统"
        I --> I1[权限缓存]
        I --> I2[会话缓存]
        I --> I3[数据缓存]
    end
    
    subgraph "外部服务"
        J --> J1[日志存储]
        K --> K1[邮件服务]
        K --> K2[消息队列]
    end
    
    L[响应数据] --> M[数据序列化]
    M --> N[响应格式化]
    N --> O[返回给用户]
    
    F --> L
```

### 5.2 权限数据流图

```mermaid
graph LR
    A[权限请求] --> B[权限服务]
    B --> C{缓存检查}
    
    C -->|命中| D[缓存权限数据]
    C -->|未命中| E[数据库查询]
    
    E --> F[用户权限表]
    E --> G[角色权限表]
    E --> H[账号关系表]
    
    F --> I[权限计算引擎]
    G --> I
    H --> I
    
    I --> J[权限结果]
    J --> K[更新缓存]
    J --> L[返回权限结果]
    
    D --> L
    
    subgraph "权限计算逻辑"
        I --> I1[基础权限]
        I --> I2[角色权限]
        I --> I3[自定义权限]
        I --> I4[权限合并]
        I4 --> J
    end
```

---

## 使用说明

### 如何查看图表

1. **在支持Mermaid的编辑器中查看**
   - VS Code + Mermaid Preview插件
   - Typora
   - GitLab/GitHub（原生支持）

2. **在线查看**
   - [Mermaid Live Editor](https://mermaid.live/)
   - 复制图表代码到在线编辑器

3. **生成图片**
   ```bash
   # 安装mermaid-cli
   npm install -g @mermaid-js/mermaid-cli
   
   # 生成PNG图片
   mmdc -i architecture-diagrams.md -o diagrams.png
   ```

### 图表更新维护

1. **添加新的业务流程**
   - 在相应章节添加新的Mermaid图表
   - 保持图表风格一致
   - 添加必要的说明文档

2. **修改现有流程**
   - 更新对应的图表代码
   - 验证图表渲染正确
   - 更新相关文档说明

3. **版本控制**
   - 重大变更时创建新版本
   - 保留历史版本的图表
   - 记录变更日志

---

*本文档最后更新时间：2025年11月*
*文档版本：v1.1*
*维护者：开发团队*